<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="บันทึกการใช้งาน Vuex + localForage" /><meta property="og:locale" content="en_US" /><meta name="description" content="บทความนี้สำหรับ Vue Developer ผู้ซึ่งผ่านการใช้งาน Vue มาในระดับหนึ่งนะครับ ซึ่งถ้าเราใช้งาน Vue มาสักพักแล้ว สิ่งที่เราหลีกเลี่ยงไม่ได้ก็คือการเก็บ state ของ application เรา ซึ่งจริง ๆ ตัว Vue มันก็เป็นตัวจัดการ view เท่านั้น ส่วนตัวที่เป็น state management เราก็สามารถเลือกใช้ได้หลาย ๆ ตัวตามใจเรา แต่สิ่งตัวที่มันค่อนข้างง่ายกับชีวิตเรามากที่สุด ก็คือตัว state management ของ Vue เอง ซึ่งได้แก่ Vuex นี่เอง" /><meta property="og:description" content="บทความนี้สำหรับ Vue Developer ผู้ซึ่งผ่านการใช้งาน Vue มาในระดับหนึ่งนะครับ ซึ่งถ้าเราใช้งาน Vue มาสักพักแล้ว สิ่งที่เราหลีกเลี่ยงไม่ได้ก็คือการเก็บ state ของ application เรา ซึ่งจริง ๆ ตัว Vue มันก็เป็นตัวจัดการ view เท่านั้น ส่วนตัวที่เป็น state management เราก็สามารถเลือกใช้ได้หลาย ๆ ตัวตามใจเรา แต่สิ่งตัวที่มันค่อนข้างง่ายกับชีวิตเรามากที่สุด ก็คือตัว state management ของ Vue เอง ซึ่งได้แก่ Vuex นี่เอง" /><link rel="canonical" href="http://localhost:4000/2019/07/27/vuex-localforage" /><meta property="og:url" content="http://localhost:4000/2019/07/27/vuex-localforage" /><meta property="og:site_name" content="MM’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-07-27T00:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="บันทึกการใช้งาน Vuex + localForage" /><meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@type":"BlogPosting","headline":"บันทึกการใช้งาน Vuex + localForage","url":"http://localhost:4000/2019/07/27/vuex-localforage","dateModified":"2019-07-27T00:00:00+07:00","datePublished":"2019-07-27T00:00:00+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/07/27/vuex-localforage"},"description":"บทความนี้สำหรับ Vue Developer ผู้ซึ่งผ่านการใช้งาน Vue มาในระดับหนึ่งนะครับ ซึ่งถ้าเราใช้งาน Vue มาสักพักแล้ว สิ่งที่เราหลีกเลี่ยงไม่ได้ก็คือการเก็บ state ของ application เรา ซึ่งจริง ๆ ตัว Vue มันก็เป็นตัวจัดการ view เท่านั้น ส่วนตัวที่เป็น state management เราก็สามารถเลือกใช้ได้หลาย ๆ ตัวตามใจเรา แต่สิ่งตัวที่มันค่อนข้างง่ายกับชีวิตเรามากที่สุด ก็คือตัว state management ของ Vue เอง ซึ่งได้แก่ Vuex นี่เอง","@context":"https://schema.org"}</script><title> บันทึกการใช้งาน Vuex + localForage - MM&#39;s Blog</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="MM's Blog" href="/atom.xml"><link rel="alternate" type="application/json" title="MM's Blog" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> @import url("https://fonts.googleapis.com/css2?family=Thasadith:wght@400;700&display=swap");@import url("https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;700&display=swap");*,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0}body{font-family:'Chakra Petch', system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">MM's Blog</h1>--><nav role="navigation"><ul><li><a href="/" >Blogs</a></li><li><a href="/search" >Search</a></li><li><a href="/atom.xml" >RSS</a></li></ul></nav></header><section class="post"><h2>บันทึกการใช้งาน Vuex + localForage</h2><p>บทความนี้สำหรับ Vue Developer ผู้ซึ่งผ่านการใช้งาน Vue มาในระดับหนึ่งนะครับ ซึ่งถ้าเราใช้งาน Vue มาสักพักแล้ว สิ่งที่เราหลีกเลี่ยงไม่ได้ก็คือการเก็บ state ของ application เรา ซึ่งจริง ๆ ตัว Vue มันก็เป็นตัวจัดการ view เท่านั้น ส่วนตัวที่เป็น state management เราก็สามารถเลือกใช้ได้หลาย ๆ ตัวตามใจเรา แต่สิ่งตัวที่มันค่อนข้างง่ายกับชีวิตเรามากที่สุด ก็คือตัว state management ของ Vue เอง ซึ่งได้แก่ Vuex นี่เอง</p><p><img src="/assets/images/migrated/0_gSqupDxO1Al_7U5e.png" alt="" />Vuex (from: <a href="https://vuex.vuejs.org/">https://vuex.vuejs.org/</a>)ในบางกรณีที่เราต้องการเก็บค่า state ของ application ของเราด้วยเหตุผลบางประการ เช่น เรื่องของ performance หรือการที่เราเก็บค่าพื้นฐานที่จะใช้ใน application ของเรา หรือเราอยากเก็บ state เพื่อความสะดวกในการ dev เราก็จำเป็นจะต้องมีการ persist state เอาไว้ใน storage ของ browser สิ่งที่แนะนำก็จะเป็น package ชื่อ “vuex-persist” (<a href="https://www.npmjs.com/package/vuex-persist">https://www.npmjs.com/package/vuex-persist</a>) ซึ่ง package นี้จะสะดวกมากในการที่จะ persist ค่าลงใน storage ต่าง ๆ ที่ browser รองรับเอาไว้ โดย storage หลัก ๆ ก็จะมีอยู่ตามนี้ครับ</p><ul><li>Cookie เป็นชิ้นข้อมูลเล็ก ๆ ที่เก็บอยู่ใน Browser โดยที่ข้อมูลนี้จะถูกส่งไปที่ server เพื่อเป็น hint ให้ server สามารถทำงานบางอย่างให้เราได้ ขนาดของ cookie ต้องไม่เกิน 4KB</li><li>Window Storage API (Local Storage และ Session Storage) เป็นข้อมูลที่เก็บไว้ในฝั่ง client โดยข้อมูลชุดนี้จะไม่มีการส่งกลับไปที่ server เลย การเข้าถึงข้อมูลจะเข้าถึงผ่าน Javascript ได้เพียงอย่างเดียว โดยความต่างของ Local Storage และ Session Storage จะต่างกันที่ความถาวรของข้อมูล โดย Session Storage จะถูกทำลายเมื่อปิด Tab ไป ในขณะที่ Local Storage จะอยู่คงทนถาวรจนกว่าจะเคลียร์ site data หรือล้าง cache ของ browser ขนาดสูงสุดจะอยู่ที่ประมาณ 5MB</li><li>IndexedDB เป็นความสามารถของ browser ที่จะเก็บข้อมูลที่มีขนาดใหญ่ขึ้น และมีโครงสร้าง โดย API ที่ใช้ในการติดต่อ IndexedDB จะเป็น API แบบ asynchronus เท่านั้น (non-blocking) โดยส่วนตัวในงานที่ทำ การเริ่มต้นใช้งาน Vuex + vue-persist + Local Storage ก็เป็นอะไรที่แฮปปี้มาก ด้วยสามองค์ประกอบนี้ทำให้การ dev ทำได้ง่ายขึ้น คือเราสามารถ reload page ได้โดยที่ไม่ต้องที่จะต้องเล่นโปรแกรมเพื่อให้เราได้ข้อมูลตามที่เราต้องการตอนเรา dev อยู่ แต่พอผ่านช่วงกระบวนการ dev แล้วเปลี่ยนมาเป็นการทดสอบโปรแกรมกับข้อมูลจริงที่มีขนาดใหญ่ขึ้น เราก็พบกับ error บางอย่างที่ไม่น่าปรารถนาขึ้น</li></ul><p><img src="/assets/images/migrated/1_tCH9vhsCxBUDFBYkhdhoIw.png" alt="" />Storage เกินโควตาหลังจากพยายามใส่ข้อมูลมาก ๆ ซึ่งเป็นฝันร้ายของนักพัฒนาอย่างเราทีนี้ตัวเลือกเดียวที่เหลืออยู่จาก storage ข้างต้นที่ browser provided ให้ ก็จะเป็นตัว IndexedDB ซึ่งจะทำให้ความแฮปปี้ของเราหายไป เนื่องจากว่า API ที่ใช้ในการติดต่อกับ IndexedDB จะมีความซับซ้อนกว่า Window Storage API (แต่เอาเข้าจริงเราก็ให้ตัว vue-persist จัดการอยู่ดี) ทีนี้ localForage ของเราก็จะเข้ามาเป็นพระเอกในงานนี้ครับ</p><p><img src="/assets/images/migrated/1_eJKWL3otVqhhjAxqzRd_pQ.png" alt="" />API ของ Window Storage ก็จะโง่ ๆ ง่าย ๆ แบบนี้localForage เป็นโปรเจคที่ถูกพัฒนาโดย Mozilla ซึ่งหลัก ๆ แล้ว localForage เป็น library ที่ทำให้เราใช้งาน IndexedDB หรือ WebSQL ได้ง่ายขึ้น โดยอารมณ์จะเป็นคล้าย ๆ wrapper ให้เราเรียกใช้ asynchronus storage ได้แบบเดียวกันกับการใช้ Window Storage เลย โดยเราไม่จำเป็นจะต้องจัดการการสร้าง database หรือเขียน query ใด ๆ ให้วุ่นวาย ถ้าหากเราจะใช้งานเป็น key-value ง่าย ๆ</p><p><img src="/assets/images/migrated/1_gCAnOHwIqzfrFpK2n_od7w.png" alt="" />API ของ localForage หน้าตาคล้าย Window Storage API แต่ผิดกันตรงที่จะ return Promise และที่สำคัญคือรองรับ TypeScript ด้วยและด้วยความโชคดี vuex-perist รองรับ localForage ด้วย!</p><p>แต่ทีนี้ด้วยธรรมชาติที่ต่างกันของ Window Storage API กับ Asynchronus Storage ก็คือความเป็น Sync/Async API ซึ่งจริง ๆ สมัยที่ใช้ Local Storage นั้น ตัว vuex-persist จะ block การทำงานของการ initialize vue ซึ่งทำให้การ restore state เกิดขึ้นก่อนการที่ Vue application ของเราจะเริ่มทำงาน ทำให้ application ของเราสามารถที่จะทำงานได้โดยมั่นใจได้ว่า state ของ application เราได้กลับมา 100% แล้ว แต่ในกรณีของการใช้งานของ localForage ซึ่งมี API เป็นแบบ asynchronus ทำให้เราไม่สามารถแน่ใจได้ว่า state ของเราจะกลับมาชัวร์ ๆ ก่อนที่ Vue application ของเราจะเริ่มทำงาน</p><p>แต่อันที่จริงแล้วมันก็ไม่ได้มีอะไรน่าตื่นเต้นยกเว้น case แปลก ๆ อย่างที่ผมพยายามจะใช้ เพราะเมื่อ state ได้ถูก restore มาใน Vuex เรียบร้อยแล้ว ตัว data ที่เป็น reactive จริง ๆ มันก็จะทำให้ component ต่าง ๆ กลับคืนมาในสภาพเดิมตามที่ state ได้กำหนดเอาไว้อยู่ดี (อันนี้คิดเองนะ เห็นก็ทำงานได้อยู่)</p><p>แล้ว case แปลก ๆ ที่ว่าคืออะไรล่ะ? เนื่องจากในงานผมจะมีการใช้งาน Vue Router ร่วมด้วย โดยในกรณีของผมจะมีการอ่านค่าใน state บางอย่าง เพื่อที่จะประเมินว่าจะให้เข้า route ดังกล่าวหรือไม่ ปัญหาก็จะเกิดขึ้นทันทีเนื่องจากว่าเราไม่สามารถที่จะแน่ใจได้เลยว่า state จะพร้อมสำหรับการใช้งานใน Vue Router แล้วหรือยัง การใช้งานดังกล่าวก็จะต้องมีเทคนิคเล็กน้อย</p><p>ใน vuex-persist <a href="https://github.com/championswimmer/vuex-persist/issues/15">issue #15</a> ก็ได้พูดถึงประเด็นนี้ โดยทางออกก็คือเราก็จะต้องหน่วงการทำงานของ Vue Router จนกว่าตัว vuex-persist จะ restore state ได้สำเร็จ สิ่งที่จะต้องทำก็คือการใส่ option strict mode ใหก้ับ vuex-persist โดยเมื่อใส่แล้ว ตัว vuex-persist จะมีการส่ง mutation ที่ชื่อว่า RESTORED_STATE จากนั้นเค้าก็ให้เรา subscribe store เพื่อหา mutation ตัวนี้ จากนั้นก็ให้ยิง event ออกมา เช่น “storageReady” ผ่านทาง root element ของ Vue จากนั้นในฝั่งของ Vue Router ให้เราไปดักตรง hook ที่เราสนใจในการ protected route ซึ่งได้แก่ router.beforeEach โดยให้เรา hold request เอาไว้ จนกว่าจะเจอ event “storageReady” เท่านี้เราก็สามารถที่จะมั่นใจได้ว่า vuex store ของเรา พร้อมที่จะให้ vue router ทำงานได้แล้ว (เรื่องโค้ดลองตามลิงค์ไปดูนะครับ)</p><p>ตอนนี้ก็ขอจบแค่นี้ก่อน ขอให้สนุกกับการ coding ครับ</p><p><a href="https://scotch.io/@PratyushB/local-storage-vs-session-storage-vs-cookie">https://scotch.io/@PratyushB/local-storage-vs-session-storage-vs-cookie</a><br /> <a href="https://arty.name/localstorage.html">https://arty.name/localstorage.html</a><br /> <a href="https://github.com/localForage/localForage">https://github.com/localForage/localForage</a></p><span class="meta"><time datetime="2019-07-27T00:00:00+07:00">July 27, 2019</time> &middot; <a href="/tag/vue">vue</a>, <a href="/tag/vuex">vuex</a>, <a href="/tag/localforage">localforage</a></span></section></main></body></html>
